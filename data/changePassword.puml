@startuml changePassword

hide footbox
mainframe <b>sd</b> Change Password For User
actor User
participant "Browser" as Browser
participant ":CommonRoleFilter" as CommonRoleFilter
participant ":ChangePasswordController" as ChangePasswordController
participant ":Helper" as Helper
participant ":GetParam" as GetParam
participant ":UserDAO" as UserDao
participant "Database" as DB

User ->> Browser: Click on change password link
activate Browser
Browser ->> CommonRoleFilter: GET /ChangePasswordController
activate CommonRoleFilter
CommonRoleFilter ->> CommonRoleFilter: Context.lookup(String name): Object
CommonRoleFilter ->> Helper: protectedRouter(HttpServletRequest request, HttpServletResponse response, int minRole, int maxRole, String page): boolean
activate Helper
Helper ->> Helper: isLogin(HttpServletRequest request): boolean
Helper ->> Helper: correctRole(HttpServletRequest request, int minRole, int maxRole): boolean
alt return false 
    Helper -->> CommonRoleFilter: forward login.jsp
    CommonRoleFilter -->> Browser: forward login.jsp
else return true
    Helper -->> CommonRoleFilter: return true
    deactivate Helper
    CommonRoleFilter ->> ChangePasswordController: doFilter(ServletRequest arg0, ServletResponse arg1): void
    deactivate CommonRoleFilter
    activate ChangePasswordController
    ChangePasswordController -->> Browser: forward changePassword.jsp
    deactivate ChangePasswordController
   
end


User ->> Browser: Submit ChangePassword Form
Browser ->> CommonRoleFilter: POST /ChangePasswordController
activate CommonRoleFilter
CommonRoleFilter ->> CommonRoleFilter: Context.lookup(String name): Object
CommonRoleFilter ->> Helper: protectedRouter(HttpServletRequest request, HttpServletResponse response, int minRole, int maxRole, String page): boolean
activate Helper
Helper ->> Helper: isLogin(HttpServletRequest request): boolean
Helper ->> Helper: correctRole(HttpServletRequest request, int minRole, int maxRole): boolean
alt return false 
    Helper -->> CommonRoleFilter: forward login.jsp
    CommonRoleFilter -->> Browser: forward login.jsp
else return true
    Helper -->> CommonRoleFilter: return true
    deactivate Helper
    CommonRoleFilter ->> ChangePasswordController: doFilter(ServletRequest arg0, ServletResponse arg1): void
    deactivate CommonRoleFilter
    activate ChangePasswordController
    ChangePasswordController ->> GetParam: getStringParam(HttpServletRequest request, String field, String label, int min, int max,String defaultValue):String
    activate GetParam
    GetParam --->> ChangePasswordController: return newPassword, confirmPassword, oldPassword 
    deactivate GetParam
    ChangePasswordController ->> ChangePasswordController: HttpSession.getAttribute(String arg0, Object arg1): void
    alt invalid data
        ChangePasswordController -->> Browser: forward changePassword.jsp
    else valid data
        ChangePasswordController ->> UserDao: getOneUserByUsername(String username): User
        activate UserDao
        UserDao ->> DB: executeQuery()
        activate DB
        DB -->> UserDao: Return result set
        deactivate DB
        UserDao -->> ChangePasswordController: User
        alt Not found user
            ChangePasswordController -->> Browser: forward changePassword.jsp
        else
            ChangePasswordController ->> Helper:  comparePassword(String inputPassword, String databasePassword, int key): boolean
            activate Helper
            Helper   -->> ChangePasswordController:  return boolean
            deactivate Helper
            ChangePasswordController   ->> ChangePasswordController:   equals(Object anObject): boolean
            alt not equal old password
                ChangePasswordController -->> Browser: forward changePassword.jsp
            else equal old password
                ChangePasswordController ->> UserDao:  updateUserPasswordByUsername(String username, String password): boolean
                UserDao ->> DB: executeUpdate()
                activate DB
                DB -->> UserDao: Return int
                deactivate DB
                UserDao -->> ChangePasswordController: return boolean
                deactivate UserDao
                alt update=false
                    ChangePasswordController -->> Browser: forward changePassword.jsp
                else  update=true
                    ChangePasswordController -->> Browser: Redirect /ViewUserController 
                    deactivate ChangePasswordController
                    deactivate Browser
                end
            end
        end
    end
end
@enduml