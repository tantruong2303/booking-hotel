@startuml addOrder

hide footbox
mainframe <b>sd</b> Add Order For Customer
actor User
participant "Browser" as Browser
participant ":CustomerRoleFilter" as CustomerRoleFilter
participant ":AddOrderController" as AddOrderController
participant "Helper" as Helper
participant ":GetParam" as GetParam
participant ":UserDAO" as UserDAO
participant ":RoomDAO" as RoomDAO
participant ":OrderDAO" as OrderDAO
participant ":BookingInfoDAO" as BookingInfoDAO
participant "Database" as DB


User ->> Browser: Click on Add Order button
activate Browser

Browser ->> CustomerRoleFilter: GET /AddOrderController
activate CustomerRoleFilter
CustomerRoleFilter ->> CustomerRoleFilter: Context.lookup(String name): Object
CustomerRoleFilter ->> Helper: protectedRouter(HttpServletRequest request, HttpServletResponse response, int minRole, int maxRole, String page): boolean
activate Helper
Helper ->> Helper: isLogin(HttpServletRequest request): boolean
Helper ->> Helper: correctRole(HttpServletRequest request, int minRole, int maxRole): boolean
alt return false 
    Helper -->> CustomerRoleFilter: forward login.jsp
    CustomerRoleFilter -->> Browser: forward login.jsp
else return true
    Helper -->> CustomerRoleFilter: return true
    CustomerRoleFilter ->> AddOrderController: doFilter(ServletRequest arg0, ServletResponse arg1): void
    activate AddOrderController
    AddOrderController ->> AddOrderController: HttpSession.getAttribute(String arg0): Object
    alt HttpSession return invalid bookingInfoList
        AddOrderController -->> CustomerRoleFilter: forward viewBookingCart.jsp
        CustomerRoleFilter -->> Browser: forward viewBookingCart.jsp
    else valid bookingInfoList
        AddOrderController ->> Helper: generateOrderId(): Integer
        Helper -->> AddOrderController: return Integer orderId
        AddOrderController ->> Helper: getCurrentDate(): Date
        Helper -->> AddOrderController: return Date createDate
        deactivate Helper
        AddOrderController ->> AddOrderController: HttpSession.getAttribute(String arg0): Object
        AddOrderController ->> UserDAO: getOneUserByUsername(String username): User
        activate UserDAO
        UserDAO ->> DB: executeQuery(): ResultSet 
        activate DB
        DB -->> UserDAO: return ResultSet rs
        deactivate DB
        UserDAO -->> AddOrderController: return User user
        deactivate UserDAO
        AddOrderController ->> OrderDAO: addOrder(Order order): boolean
        activate OrderDAO
        OrderDAO ->> DB: executeUpdate(): PrepareStatement 
        activate DB
        DB -->> OrderDAO: return int preStm.executeUpdate()
        deactivate DB
        OrderDAO -->> AddOrderController: return boolean isSuccess
        alt isSuccess = false
            AddOrderController -->> CustomerRoleFilter: forward viewBookingCart.jsp
        CustomerRoleFilter -->> Browser: forward viewBookingCart.jsp
        else isSuccess = true
            AddOrderController ->> RoomDAO: getRoomById(int roomId): Room
            activate RoomDAO
            RoomDAO ->> DB: executeQuery(): ResultSet 
            activate DB
            DB -->> RoomDAO: return ResultSet rs
            deactivate DB
            RoomDAO -->> AddOrderController: return Room room
            deactivate RoomDAO
            alt invalid room
                AddOrderController -->> CustomerRoleFilter: forward viewBookingCart.jsp
                CustomerRoleFilter -->> Browser: forward viewBookingCart.jsp
            else valid room
                AddOrderController ->> BookingInfoDAO: getActiveBookingWithRoomId(Integer roomId): ArrayList<BookingInfo>
                activate BookingInfoDAO
                BookingInfoDAO ->> DB: executeQuery(): ResultSet 
                activate DB
                DB -->> BookingInfoDAO: return ResultSet rs
                deactivate DB
                BookingInfoDAO -->> AddOrderController: return ArrayList<BookingInfo> bookings
                alt invalid bookings
                    AddOrderController -->> CustomerRoleFilter: forward viewBookingCart.jsp
                    CustomerRoleFilter -->> Browser: forward viewBookingCart.jsp
                else valid bookings
                    AddOrderController ->> BookingInfoDAO: addBookingInfo(BookingInfo bookingInfo): boolean
                    BookingInfoDAO ->> DB: executeUpdate(): PrepareStatement
                    activate DB
                    DB -->> BookingInfoDAO: return int preStm.executeUpdate()
                    deactivate DB
                    BookingInfoDAO -->> AddOrderController: return boolean isSuccess
                    deactivate BookingInfoDAO
                    alt isSuccess = false
                        AddOrderController -->> CustomerRoleFilter: forward viewBookingCart.jsp
                        CustomerRoleFilter -->> Browser: forward viewBookingCart.jsp
                    else isSuccess = true
                        AddOrderController ->> AddOrderController: HttpSession.setAttribute(String arg0, Object arg1): void
                        AddOrderController ->> OrderDAO: updateOrder(Order order): boolean
                        OrderDAO ->> DB: executeUpdate(): PrepareStatement 
                        activate DB
                        DB -->> OrderDAO: return int preStm.executeUpdate()
                        deactivate DB
                        OrderDAO -->> AddOrderController: return boolean isSuccess
                        deactivate OrderDAO
                        alt isSuccess = false
                            AddOrderController -->> CustomerRoleFilter: forward viewBookingCart.jsp
                            CustomerRoleFilter -->> Browser: forward viewBookingCart.jsp
                        else isSuccess = true
                            AddOrderController ->> AddOrderController: HttpSession.removeAttribute(String arg0): void
                            AddOrderController -->> CustomerRoleFilter: Redirect /ViewBookingController
                            deactivate AddOrderController
                            CustomerRoleFilter -->> Browser: Redirect /ViewBookingController
                            deactivate CustomerRoleFilter
                            deactivate Browser
                        end
                    end
                end
            end
        end
    end
end
@enduml